<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>4.  Finding errors</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2022-06-19T16:15:12Z"/><meta name="generator" content="DocBook xslTNG version 1.7.0-11 / 9c7793e8 / SAXON HE 10.6"/><link href="/css/docbook.css" rel="stylesheet"/><link href="/css/docbook-screen.css" rel="stylesheet"/><link href="/css/nineml.css" rel="stylesheet"/><link href="/css/coffeepot.css" rel="stylesheet"/><link href="/css/toc.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script src="https://kit.fontawesome.com/498b6706f0.js" type="text/javascript" crossorigin="anonymous"></script><link href="icon/CoffeePot.png" rel="shortcut icon"/><link rel="prev" href="ch03.html"/><link rel="next" href="ch05.html"/><link rel="up" href="index.html"/><link rel="home" href="index.html"/></head><body><nav class="top"><span class="nav"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a>Â <a href="ch03.html" title="3.  How it works"><i class="fas fa-arrow-left"></i></a>Â <a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a>Â <a title="5.  Ambiguity" href="ch05.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">CoffeePot</i></span></nav><main><div id="debugging" class="chapter"><header><h2><span class="number">4<span class="sep">. </span></span>Finding errors</h2></header><p>On a good day, your grammars are all valid and your inputs all parse.
On a day that ends in â€œyâ€, not so much.</p><p>If <span class="application">coffeepot</span> fails to parse your
grammar, it will attempt to identify where the error occurs. Consider
this grammar, <a href="examples/err01.ixml" class="link">err01.ixml</a>:
</p><div id="err01" class="example"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>list: word + -',' .</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>word: c, v, c ; c, v, v</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>-c: ["bcdfghjklmnpqrstvwxyz"] .</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>-v: ["aeiouy" ].</code></span></span>
</pre></div><header><div class="title"><span class="label">Example<span class="sep">Â </span></span><span class="number">4<span class="sep">.</span>1<span class="sep">Â </span></span>Sequences of short words (invalid)</div></header></div><p>In principle, this is a grammar matching comma-separated
sequences of short words matching the pattern
â€œconsonant-vowel-consonantâ€ or â€œconsonent-vowel-vowelâ€. In practice,
itâ€™s not:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>$ coffeepot -pp -g:examples/err01.ixml cat,sat,hat</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>Failed to parse grammar: could not match '-' at line 3, column 1</code></span></span>
</pre></div><p>In typical â€œerror messages from computer programsâ€ fashion, this doesnâ€™t
actually tell you whatâ€™s wrong. It tells you the first thing the parser
didnâ€™t understand, the â€œ-â€ at the start of line 3. Thereâ€™s nothing wrong with
that hyphen, but if you look just before it, you will see that the preceding
rule is missing the terminating â€œ.â€.</p><p>With that addition, we get
<a href="examples/err02.ixml" class="link">err02.ixml</a>:
</p><div id="err02" class="example"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>list: word + -',' .</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>word: c, v, c ; c, v, v .</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>-c: ["bcdfghjklmnpqrstvwxyz"] .</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>-v: ["aeiouy" ].</code></span></span>
</pre></div><header><div class="title"><span class="label">Example<span class="sep">Â </span></span><span class="number">4<span class="sep">.</span>2<span class="sep">Â </span></span>Sequences of short words</div></header></div><p>Which does work:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml cat,sat,hat</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>&lt;list&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>   &lt;word&gt;cat&lt;/word&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>   &lt;word&gt;sat&lt;/word&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln"></span><span class="ld"><code>   &lt;word&gt;hat&lt;/word&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln"></span><span class="ld"><code>&lt;/list&gt;</code></span></span>
</pre></div><p>Once your grammar works, you can start feeding inputs to it. Some of
those wonâ€™t work.</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml frog,sat,log</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>&lt;fail xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>   &lt;line&gt;1&lt;/line&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>   &lt;column&gt;3&lt;/column&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln"></span><span class="ld"><code>   &lt;pos&gt;2&lt;/pos&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln"></span><span class="ld"><code>   &lt;unexpected&gt;r&lt;/unexpected&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln"></span><span class="ld"><code>   &lt;permitted&gt;["aeuiyo"]&lt;/permitted&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln"></span><span class="ld"><code>&lt;/fail&gt;</code></span></span>
</pre></div><p>There is no universally correct answer to the question: is your
grammar incorrect or is your input incorrect? In fact, if what you
wanted to demonstrate was that a paricular input <em>was
not</em> a sentence in the grammar, then
<em>neither</em> may be incorrect.</p><p>If you have reasonable confidence in your grammar and you did
expect the input to match, the next question to answer is, why didnâ€™t
it?</p><p>The â€œparse-failedâ€ document attempts to identify where the error
occurred. As before, what we see in the error is where the parser was
when it couldnâ€™t continue. In this case, note that it read as far as
the third character, but in fact had failed at the second, the â€œrâ€.
</p><p>Why arenâ€™t the numbers more accurate? The short answer is:
because the parser canâ€™t know that it wonâ€™t succeed until itâ€™s â€œrun
outâ€ of possible matches. That almost always means reading at least
one character past the error, but sometimes several.
</p><div class="admonition note"><div><div class="icon">ğŸ›ˆï¸</div><div class="body"><header><div class="title">Also predictedâ€¦</div></header><div><p>Sometimes, in addition to a list of permitted tokens, youâ€™ll get
an additional set of â€œalso predictedâ€ tokens. This happens when the
parser is in the middle of something that could have continued (with
one of the permitted tokens), but the parser has also made predictions
about what could come <em>after</em> what itâ€™s trying to
finish. The also predicted tokens are an indication of what it would have
accepted next.</p></div></div></div></div><p>With this simple grammar, itâ€™s not too hard to look at the input
and work out that â€œfrogâ€ is neither â€œconsonant-vowel-consonantâ€ nor
â€œconsonent-vowel-vowelâ€. Itâ€™s four letters long, if nothing else!</p><p>But suppose it hadnâ€™t been so easy to spot. We can ask the parser for more 
details, but beware, you sometimes get <em>a lot</em> of detail!
The <code class="option">--show-chart</code> option tells <span class="application">coffeepot</span> to
print the state chart that was current at the moment of failure.</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml --show-chart frog,sat,log</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>&lt;parse-failed xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>   &lt;last-token line="1" column="3" token-count="2"&gt;'r'&lt;/last-token&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>   &lt;chart&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln"></span><span class="ld"><code>      &lt;row n="0"&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;$$ â‡’ â€¢ list / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;list â‡’ â€¢ $1 / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;$1 â‡’ â€¢ word $2â¿ / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="9"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;word â‡’ â€¢ c v c / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="10"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;word â‡’ â€¢ c v v / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="11"><span class="ln"></span><span class="ld"><code>      &lt;/row&gt;</code></span></span>
<span class="line" db-line="12"><span class="ln"></span><span class="ld"><code>      &lt;row n="1"&gt;</code></span></span>
<span class="line" db-line="13"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;c â‡’ ["bcdfghjklmnpqrstvwxyz"] â€¢ / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="14"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;word â‡’ c â€¢ v c / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="15"><span class="ln"></span><span class="ld"><code>         &lt;item&gt;word â‡’ c â€¢ v v / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="16"><span class="ln"></span><span class="ld"><code>      &lt;/row&gt;</code></span></span>
<span class="line" db-line="17"><span class="ln"></span><span class="ld"><code>   &lt;/chart&gt;</code></span></span>
<span class="line" db-line="18"><span class="ln"></span><span class="ld"><code>&lt;/parse-failed&gt;</code></span></span>
</pre></div><p>To understand the state chart, it will be useful to know something about how
an <a href="https://en.wikipedia.org/wiki/Earley_parser" class="link">Earley parser</a>
works, and understand the <a href="ch03.html" class="link">rewriting rules</a> that are applied
to your Invisible XML grammar.</p><p>Roughly speaking, each row in the chart represents the state of the parser when
that input token is or was processed. Row 0 represents what the parser predicted before
the first character. Row 1 represents what it matched and predicted for the first character,
etc. The last row in a failed parse represents what it was hoping to match when it failed.
</p><p>Each item in the chart has three parts. It starts with the rule
being considered. The â€œâ€¢â€ indicates how much of each rule has been
successfully matched. The second part indicates where this item came from (on what row
of the chart did we begin predicting this as a possible matching rule?). The last
part is the forest node under construction for this item. Thatâ€™s part of the machinery
for constructing a graph that contains all of the possible parses.</p><p>Looking at the last row, we can see that the parser
was trying to match <code>word</code>, it had a couple of ways to do so, in each case, it
had matched the first consonant (because â€¢ is after â€œcâ€ in each case), and failed to find
the next match, a vowel in both cases. Not surprising since â€œrâ€ isnâ€™t a vowel!</p><p>Letâ€™s look at another unsuccessful attempt:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml  cat,ate,rat</code></span></span>
<span class="line" db-line="2"><span class="ln"></span><span class="ld"><code>&lt;fail xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln"></span><span class="ld"><code>   &lt;line&gt;1&lt;/line&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln"></span><span class="ld"><code>   &lt;column&gt;6&lt;/column&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln"></span><span class="ld"><code>   &lt;pos&gt;5&lt;/pos&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln"></span><span class="ld"><code>   &lt;unexpected&gt;a&lt;/unexpected&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln"></span><span class="ld"><code>   &lt;permitted&gt;["bcdfghjklmnpqrstvwxyz"]&lt;/permitted&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln"></span><span class="ld"><code>&lt;/fail&gt;</code></span></span>
</pre></div><p>The state chart isnâ€™t the only tool we have to understand what went wrong.
We can also look at what was in the parse forest with the <code class="option">--graph-svg</code>
option (if you <a href="ch06.html" class="link">have configured</a> GraphViz).</p><div id="err02-forest-cat.svg" class="figure"><div class="mediaobject"><div class="imageobject"><div class="media"><img src="/images/err02-forest-cat.svg"/></div></div></div><header><div class="title"><span class="label">Figure<span class="sep">Â </span></span><span class="number">4<span class="sep">.</span>1<span class="sep">Â </span></span>The parse forest for an unsuccessful match of cat,ate,rat</div></header></div><p>Looking at the leaves, we can see that â€œcatâ€ was connected into the graph, but
â€œ,â€ and â€œaâ€ are unconnected. Thatâ€™s a clue about what wasnâ€™t matched. For non-trivial
examples, the graphs can get very large, sometimes too large for GraphViz to even compute.
But they can still be valuable aids to understanding the parse.</p><p>One thing worth noting: on a successful parse, when the final
graph is constructed, an â€œunreachableâ€ nodes are pruned away. A graph
produced mid-parse canâ€™t be pruned, so there are often extra â€œrootâ€
nodes.</p></div></main><nav class="bottom"><div class="navrow"><div class="navleft"><a title="3.  How it works" href="ch03.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="5.  Ambiguity" href="ch05.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle">3.  How it works</div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle">5.  Ambiguity</div></div><div class="infofooter"><span class="copyrightfooter">Copyright Â© 2022 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that donâ€™t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div><ul class="toc"><li><a href="pf01.html">Introduction</a></li><li><a href="ch01.html"><span class="number">1<span class="sep">. </span></span>Installing CoffeePot</a></li><li><a href="ch02.html"><span class="number">2<span class="sep">. </span></span>Running CoffeePot</a><ul class="toc"><li><a href="ch02.html#cli"><span class="number">2<span class="sep">.</span>1<span class="sep">Â </span></span>The command line</a></li><li><a href="ch02.html#buildtools"><span class="number">2<span class="sep">.</span>2<span class="sep">Â </span></span>In build tools</a></li></ul></li><li><a href="ch03.html"><span class="number">3<span class="sep">. </span></span>How it works</a><ul class="toc"><li><a href="ch03.html#earleymapping01"><span class="number">3<span class="sep">.</span>1<span class="sep">Â </span></span>Mapping a simple rule</a></li><li><a href="ch03.html#earleymapping02"><span class="number">3<span class="sep">.</span>2<span class="sep">Â </span></span>Mapping alternatives</a></li><li><a href="ch03.html#earleymapping03"><span class="number">3<span class="sep">.</span>3<span class="sep">Â </span></span>Mapping â€œx?â€</a></li><li><a href="ch03.html#earleymapping03b"><span class="number">3<span class="sep">.</span>4<span class="sep">Â </span></span>Mapping â€œ(x1, x2)?â€</a></li><li><a href="ch03.html#earleymapping04"><span class="number">3<span class="sep">.</span>5<span class="sep">Â </span></span>Mapping â€œx*â€</a></li><li><a href="ch03.html#earleymapping05"><span class="number">3<span class="sep">.</span>6<span class="sep">Â </span></span>Mapping â€œx+â€</a></li><li><a href="ch03.html#earleymapping06"><span class="number">3<span class="sep">.</span>7<span class="sep">Â </span></span>Mapping â€œx1**x2â€</a></li><li><a href="ch03.html#earleymapping07"><span class="number">3<span class="sep">.</span>8<span class="sep">Â </span></span>Mapping â€œx1++x2â€</a></li><li><a href="ch03.html#earleymapping08"><span class="number">3<span class="sep">.</span>9<span class="sep">Â </span></span>Mapping Â¯\_(ãƒ„)_/Â¯</a></li><li><a href="ch03.html#dashetc"><span class="number">3<span class="sep">.</span>10<span class="sep">Â </span></span>A word about â€œ-â€, â€œ@â€, and â€œ^â€</a></li><li><a href="ch03.html#insertions"><span class="number">3<span class="sep">.</span>11<span class="sep">Â </span></span>Insertions</a></li></ul></li><li><a href="ch04.html"><span class="number">4<span class="sep">. </span></span>Finding errors</a></li><li><a href="ch05.html"><span class="number">5<span class="sep">. </span></span>Ambiguity</a></li><li><a href="ch06.html"><span class="number">6<span class="sep">. </span></span>Configuration</a></li><li><a href="ch07.html"><span class="number">7<span class="sep">. </span></span>Output formats</a><ul class="toc"><li><a href="ch07.html#output-xml"><span class="number">7<span class="sep">.</span>1<span class="sep">Â </span></span>XML</a></li><li><a href="ch07.html#output-json"><span class="number">7<span class="sep">.</span>2<span class="sep">Â </span></span>JSON</a></li><li><a href="ch07.html#output-csv"><span class="number">7<span class="sep">.</span>3<span class="sep">Â </span></span>CSV</a></li></ul></li><li><a href="ch08.html"><span class="number">8<span class="sep">. </span></span>Pragmas</a><ul class="toc"><li><a href="ch08.html#pragmas-grammar"><span class="number">8<span class="sep">.</span>1<span class="sep">Â </span></span>Grammar pragmas</a><ul class="toc"><li><a href="ch08.html#pragma-csv-columns"><span class="number">8<span class="sep">.</span>1<span class="sep">.</span>1<span class="sep">Â </span></span>csv-columns</a></li><li><a href="ch08.html#pragma-import"><span class="number">8<span class="sep">.</span>1<span class="sep">.</span>2<span class="sep">Â </span></span>import</a></li><li><a href="ch08.html#pragma-xmlns"><span class="number">8<span class="sep">.</span>1<span class="sep">.</span>3<span class="sep">Â </span></span>xmlns</a></li></ul></li><li><a href="ch08.html#pragmas-rules"><span class="number">8<span class="sep">.</span>2<span class="sep">Â </span></span>Rule pragmas</a><ul class="toc"><li><a href="ch08.html#pragma-csv-heading"><span class="number">8<span class="sep">.</span>2<span class="sep">.</span>1<span class="sep">Â </span></span>csv-heading</a></li><li><a href="ch08.html#pragma-discard-empty"><span class="number">8<span class="sep">.</span>2<span class="sep">.</span>2<span class="sep">Â </span></span>discard-empty</a></li><li><a href="ch08.html#pragma-combine"><span class="number">8<span class="sep">.</span>2<span class="sep">.</span>3<span class="sep">Â </span></span>combine</a></li><li><a href="ch08.html#pragma-regex"><span class="number">8<span class="sep">.</span>2<span class="sep">.</span>4<span class="sep">Â </span></span>regex</a></li></ul></li><li><a href="ch08.html#pragmas-symbols"><span class="number">8<span class="sep">.</span>3<span class="sep">Â </span></span>Symbol pragmas</a><ul class="toc"><li><a href="ch08.html#pragma-rename"><span class="number">8<span class="sep">.</span>3<span class="sep">.</span>1<span class="sep">Â </span></span>rename</a></li><li><a href="ch08.html#pragma-rewrite"><span class="number">8<span class="sep">.</span>3<span class="sep">.</span>2<span class="sep">Â </span></span>rewrite</a></li></ul></li></ul></li><li><a href="appa.html"><span class="label">Appendix<span class="sep">Â </span></span><span class="number">A<span class="sep">. </span></span>Property files</a><ul class="toc"><li><a href="appa.html#pf001"><span class="number">A<span class="sep">.</span>1<span class="sep">Â </span></span>A first attempt</a></li><li><a href="appa.html#pf002"><span class="number">A<span class="sep">.</span>2<span class="sep">Â </span></span>Refining name-value</a></li><li><a href="appa.html#pf003"><span class="number">A<span class="sep">.</span>3<span class="sep">Â </span></span>More line options</a></li><li><a href="appa.html#pf004"><span class="number">A<span class="sep">.</span>4<span class="sep">Â </span></span>Character escapes</a></li><li><a href="appa.html#pf005"><span class="number">A<span class="sep">.</span>5<span class="sep">Â </span></span>Challenges for the reader</a></li></ul></li><li><a href="appb.html"><span class="label">Appendix<span class="sep">Â </span></span><span class="number">B<span class="sep">. </span></span>Caching</a></li><li><a href="appc.html"><span class="label">Appendix<span class="sep">Â </span></span><span class="number">C<span class="sep">. </span></span>Change log</a></li></ul></div></script></nav><script src="/js/persistent-toc.js"></script><script src="/js/chunk-nav.js"></script></body></html>