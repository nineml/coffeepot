<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>Chapter 4. Finding errors</title><link href="/css/pygments.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2023-07-23T09:31:49Z"/><meta name="generator" content="DocBook xslTNG version 2.1.6 / cf0b935 / SAXON EE 12.3"/><link href="/css/docbook-toc.css" rel="stylesheet"/><link href="/css/docbook.css" rel="stylesheet" media="screen"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script src="https://kit.fontawesome.com/498b6706f0.js" type="text/javascript" crossorigin="anonymous"></script><link href="icon/CoffeePot.png" rel="shortcut icon"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="css/nineml.css" rel="stylesheet"/><link href="css/coffeepot.css" rel="stylesheet"/><link rel="prev" href="ch03.html"/><link rel="next" href="ch05.html"/><link rel="up" href="index.html"/><link rel="home" href="index.html"/><script src="/js/persistent-toc.js" defer="defer"></script><script src="/js/copy-verbatim.js" defer="defer"></script><script src="/js/chunk-nav.js" defer="defer"></script></head><body><nav class="top"><span class="nav"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a> <a href="ch03.html" title="Chapter  3 .  How it works"><i class="fas fa-arrow-left"></i></a> <a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a> <a title="Chapter  5 .  Ambiguity" href="ch05.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">CoffeePot</i></span></nav><main><section id="debugging" db-chunk="ch04.html" db-id="d94e751" class="chapter component"><header><h2>Chapter <span class="label">4</span><span class="sep">. </span>Finding errors</h2></header><p>On a good day, your grammars are all valid and your inputs all parse.
On a day that ends in “y”, not so much.</p><p>If <span class="application">coffeepot</span> fails to parse your
grammar, it will attempt to identify where the error occurs. Consider
this grammar, <a href="examples/err01.ixml" class="link">err01.ixml</a>:
</p><div id="err01" class="example formalobject"><header><div class="title">Example <span class="label">4<span class="sep">.</span>1</span><span class="sep">. </span>Sequences of short words (invalid)</div></header><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>list: word + -',' .</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>word: c, v, c ; c, v, v</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-c: ["bcdfghjklmnpqrstvwxyz"] .</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-v: ["aeiouy" ].</code></span></span>
</pre></div></div><p>In principle, this is a grammar matching comma-separated
sequences of short words matching the pattern
“consonant-vowel-consonant” or “consonent-vowel-vowel”. In practice,
it’s not:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>$ coffeepot -pp -g:examples/err01.ixml cat,sat,hat</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>Failed to parse grammar: could not match '-' at line 3, column 1</code></span></span>
</pre></div><p>In typical “error messages from computer programs” fashion, this doesn’t
actually tell you what’s wrong. It tells you the first thing the parser
didn’t understand, the “-” at the start of line 3. There’s nothing wrong with
that hyphen, but if you look just before it, you will see that the preceding
rule is missing the terminating “.”.</p><p>With that addition, we get
<a href="examples/err02.ixml" class="link">err02.ixml</a>:
</p><div id="err02" class="example formalobject"><header><div class="title">Example <span class="label">4<span class="sep">.</span>2</span><span class="sep">. </span>Sequences of short words</div></header><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>list: word + -',' .</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>word: c, v, c ; c, v, v .</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-c: ["bcdfghjklmnpqrstvwxyz"] .</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-v: ["aeiouy" ].</code></span></span>
</pre></div></div><p>Which does work:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml cat,sat,hat</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;list&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;word&gt;cat&lt;/word&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;word&gt;sat&lt;/word&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;word&gt;hat&lt;/word&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;/list&gt;</code></span></span>
</pre></div><p>Once your grammar works, you can start feeding inputs to it. Some of
those won’t work.</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml frog,sat,log</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;fail xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;line&gt;1&lt;/line&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;column&gt;3&lt;/column&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;pos&gt;2&lt;/pos&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;unexpected&gt;r&lt;/unexpected&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;permitted&gt;["aeuiyo"]&lt;/permitted&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;/fail&gt;</code></span></span>
</pre></div><p>There is no universally correct answer to the question: is your
grammar incorrect or is your input incorrect? In fact, if what you
wanted to demonstrate was that a paricular input <em>was
not</em> a sentence in the grammar, then
<em>neither</em> may be incorrect.</p><p>If you have reasonable confidence in your grammar and you did
expect the input to match, the next question to answer is, why didn’t
it?</p><p>The “parse-failed” document attempts to identify where the error
occurred. As before, what we see in the error is where the parser was
when it couldn’t continue. In this case, note that it read as far as
the third character, but in fact had failed at the second, the “r”.
</p><p>Why aren’t the numbers more accurate? The short answer is:
because the parser can’t know that it won’t succeed until it’s “run
out” of possible matches. That almost always means reading at least
one character past the error, but sometimes several.
</p><div class="admonition note"><div><div class="icon">ⓘ</div><div class="body"><header><div class="title">Also predicted…</div></header><div><p>Sometimes, in addition to a list of permitted tokens, you’ll get
an additional set of “also predicted” tokens. This happens when the
parser is in the middle of something that could have continued (with
one of the permitted tokens), but the parser has also made predictions
about what could come <em>after</em> what it’s trying to
finish. The also predicted tokens are an indication of what it would have
accepted next.</p></div></div></div></div><p>With this simple grammar, it’s not too hard to look at the input
and work out that “frog” is neither “consonant-vowel-consonant” nor
“consonent-vowel-vowel”. It’s four letters long, if nothing else!</p><p>But suppose it hadn’t been so easy to spot. We can ask the parser for more 
details, but beware, you sometimes get <em>a lot</em> of detail!
The <a href="ch02.html#_show-chart"><code class="option">--show-chart</code></a> option tells <span class="application">coffeepot</span> to
print the state chart that was current at the moment of failure.</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml --show-chart frog,sat,log</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>&lt;parse-failed xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>   &lt;last-token line="1" column="3" token-count="2"&gt;'r'&lt;/last-token&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>   &lt;chart&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>      &lt;row n="0"&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;$$ ⇒ • list / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;list ⇒ • $1 / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;$1 ⇒ • word $2ⁿ / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;word ⇒ • c v c / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="10"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;word ⇒ • c v v / 0 / null&lt;/item&gt;</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>      &lt;/row&gt;</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>      &lt;row n="1"&gt;</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;c ⇒ ["bcdfghjklmnpqrstvwxyz"] • / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;word ⇒ c • v c / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="15"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>         &lt;item&gt;word ⇒ c • v v / 0 / c, 0, 1&lt;/item&gt;</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>      &lt;/row&gt;</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>   &lt;/chart&gt;</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>&lt;/parse-failed&gt;</code></span></span>
</pre></div><p>To understand the state chart, it will be useful to know something about how
an <a href="https://en.wikipedia.org/wiki/Earley_parser" class="link">Earley parser</a>
works, and understand the <a href="ch03.html" class="link">rewriting rules</a> that are applied
to your Invisible XML grammar.</p><p>Roughly speaking, each row in the chart represents the state of the parser when
that input token is or was processed. Row 0 represents what the parser predicted before
the first character. Row 1 represents what it matched and predicted for the first character,
etc. The last row in a failed parse represents what it was hoping to match when it failed.
</p><p>Each item in the chart has three parts. It starts with the rule
being considered. The “•” indicates how much of each rule has been
successfully matched. The second part indicates where this item came from (on what row
of the chart did we begin predicting this as a possible matching rule?). The last
part is the forest node under construction for this item. That’s part of the machinery
for constructing a graph that contains all of the possible parses.</p><p>Looking at the last row, we can see that the parser
was trying to match <code>word</code>, it had a couple of ways to do so, in each case, it
had matched the first consonant (because • is after “c” in each case), and failed to find
the next match, a vowel in both cases. Not surprising since “r” isn’t a vowel!</p><p>Let’s look at another unsuccessful attempt:</p><div class="pre-wrap"><pre class="language-none programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>$ coffeepot -pp -g:examples/err02.ixml  cat,ate,rat</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;fail xmlns:ixml="http://invisiblexml.org/NS" ixml:state="failed"&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;line&gt;1&lt;/line&gt;</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;column&gt;6&lt;/column&gt;</code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;pos&gt;5&lt;/pos&gt;</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;unexpected&gt;a&lt;/unexpected&gt;</code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   &lt;permitted&gt;["bcdfghjklmnpqrstvwxyz"]&lt;/permitted&gt;</code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>&lt;/fail&gt;</code></span></span>
</pre></div><p>The state chart isn’t the only tool we have to understand what went wrong.
We can also look at what was in the parse forest with the <code class="option">--graph-svg</code>
option (if you <a href="ch07.html" class="link">have configured</a> GraphViz).</p><div id="err02-forest-cat.svg" class="figure formalobject"><header><div class="title">Figure <span class="label">4<span class="sep">.</span>1</span><span class="sep">. </span>The parse forest for an unsuccessful match of cat,ate,rat</div></header><div class="mediaobject"><div class="media image"><picture class="imageobject"><img src="/images/err02-forest-cat.svg"/></picture></div></div></div><p>Looking at the leaves, we can see that “cat” was connected into the graph, but
“,” and “a” are unconnected. That’s a clue about what wasn’t matched. For non-trivial
examples, the graphs can get very large, sometimes too large for GraphViz to even compute.
But they can still be valuable aids to understanding the parse.</p><p>One thing worth noting: on a successful parse, when the final
graph is constructed, an “unreachable” nodes are pruned away. A graph
produced mid-parse can’t be pruned, so there are often extra “root”
nodes.</p></section></main><nav class="bottom"><div class="navrow"><div class="navleft"><a title="Chapter  3 .  How it works" href="ch03.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="Chapter  5 .  Ambiguity" href="ch05.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle">Chapter  3 .  How it works</div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle">Chapter  5 .  Ambiguity</div></div><div class="infofooter"><span class="copyrightfooter">Copyright © 2022–2023 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that don’t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div db-persistent-toc="persistent-toc.html" db-prefix="">Loading…</div></script></nav></body></html>