<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>Chapter 6. Choosing among alternatives</title><link href="/css/pygments.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2023-07-23T09:22:34Z"/><meta name="generator" content="DocBook xslTNG version 2.1.6 / cf0b935 / SAXON EE 12.3"/><link href="/css/docbook-toc.css" rel="stylesheet"/><link href="/css/docbook.css" rel="stylesheet" media="screen"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script src="https://kit.fontawesome.com/498b6706f0.js" type="text/javascript" crossorigin="anonymous"></script><link href="icon/CoffeePot.png" rel="shortcut icon"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="css/nineml.css" rel="stylesheet"/><link href="css/coffeepot.css" rel="stylesheet"/><link rel="prev" href="ch05.html"/><link rel="next" href="ch07.html"/><link rel="up" href="index.html"/><link rel="home" href="index.html"/><script src="/js/persistent-toc.js" defer="defer"></script><script src="/js/copy-verbatim.js" defer="defer"></script><script src="/js/chunk-nav.js" defer="defer"></script></head><body><nav class="top"><span class="nav"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a> <a href="ch05.html" title="Chapter  5 .  Ambiguity"><i class="fas fa-arrow-left"></i></a> <a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a> <a title="Chapter  7 .  Configuration" href="ch07.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">CoffeePot</i></span></nav><main><section id="choose-alternative" db-chunk="ch06.html" db-id="d94e974" class="chapter component"><header><h2>Chapter <span class="label">6</span><span class="sep">. </span>Choosing among alternatives</h2></header><p>Where it’s practical to write a grammar that is unambiguous,
that’s best. But it isn’t always practical. Sometimes it’s difficult,
and sometimes it’s impossible. If the data is actually ambiguous, you
may have to reflect that in your grammar.</p><p>Invisible XML doesn’t consider ambiguity an error, but it also
doesn’t provide any mechanism for controlling it. All parses are
considered equal and the processor’s only obligation is to provide one
of them.</p><p>Consider this simple, ambiguous grammar:</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="6"><pre class="language-ixml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code>   number-list = (number, -#a)+, number? .</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>        number = hex | decimal .</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>           hex = hex-digit+ .</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>       decimal = decimal-digit+ .</code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>    -hex-digit = ["0"-"9" | "a"-"f" | "A"-"F" ] .</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-decimal-digit = ["0"-"9" ] .</code></span></span>
</pre></div><p>If we parse the following input,</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="3"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>bad</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>cafe</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>42</code></span></span>
</pre></div><p>We might get this result:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="5"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;number-list</span> <span class="na">xmlns:ixml=</span><span class="s">"http://invisiblexml.org/NS"</span> <span class="na">ixml:state=</span><span class="s">"ambiguous"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>bad<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>cafe<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>42<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/number-list&gt;</span></code></span></span>
</pre></div><p>Of course, we might equally get this result:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="5"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;number-list</span> <span class="na">xmlns:ixml=</span><span class="s">"http://invisiblexml.org/NS"</span> <span class="na">ixml:state=</span><span class="s">"ambiguous"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>bad<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>cafe<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;decimal&gt;</span>42<span class="nt">&lt;/decimal&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/number-list&gt;</span></code></span></span>
</pre></div><p>The ambiguity here is between “decimal” and “hexidecimal”. You
may wish to control which one is selected. CoffeePot provides two ways
to examine the alternatives and select one: you can provide a function
library that defines
<a href="https://coffeesacks.nineml.org/ch07.html" class="link">a
function</a> that chooses between them, or you can provide a list
of XPath expressions to select an alternative. Using a function
library requires Saxon PE or Saxon EE.</p><p>If both a function library and XPath expressions are provided,
the function library is used first and the expressions are only used
if the function library does not select an alternative.</p><section id="choose-function" class="section"><header><h2><span class="label">6<span class="sep">.</span>1</span><span class="sep">. </span>Using a function library</h2></header><p>To use a function library, you must provide an XSLT stylesheet or XQuery module
that defines a function named <code class="function">choose-alternative</code> in the
namespace <code class="uri">https://coffeepot.nineml.org/ns/functions</code>. The function must 
two parameters: an element and a map. It must return a map.
</p><p>Here is an example of an XSLT function library that will always select the
decimal alternative:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="17"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;xsl:stylesheet</span> <span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span></code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>                <span class="na">xmlns:cp=</span><span class="s">"https://coffeepot.nineml.org/ns/functions"</span></code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>                <span class="na">exclude-result-prefixes=</span><span class="s">"#all"</span></code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code>                <span class="na">version=</span><span class="s">"3.0"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;xsl:function</span> <span class="na">name=</span><span class="s">"cp:choose-alternative"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"context"</span> <span class="na">as=</span><span class="s">"element()"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"options"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"choice"</span></code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>                <span class="na">select=</span><span class="s">"$context/children[symbol[@name='decimal']]/@id"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:sequence</span> <span class="na">select=</span><span class="s">"map { 'selection': $choice }"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/xsl:function&gt;</span></code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/xsl:stylesheet&gt;</span></code></span></span>
</pre></div><p>For example:</p><div class="pre-wrap"><pre class="screen verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \</code></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="userinput">            --pretty-print --function-library:numbers.xsl</code></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">Found 2 possible parses.</code></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;</code></code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;bad&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;cafe&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;decimal&gt;42&lt;/decimal&gt;</code></code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;/number-list&gt;</code></code></span></span>
</pre></div><p>An alternative function library that always selects hexidecimal
could be written in XQuery this way:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="10"><pre class="language-xquery long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code><span class="kd">module</span> <span class="kd">namespace</span><span class="w"> </span><span class="nn">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://coffeepot.nineml.org/ns/functions"</span><span class="p">;</span><span class="w"></span></code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="kd">declare</span> <span class="kd">function</span><span class="w"> </span><span class="nf">f:choose-alternative</span><span class="p">(</span><span class="w"></span></code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nv">$</span><span class="n">context</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nt">element</span><span class="p">(),</span><span class="w"></span></code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nv">$</span><span class="n">options</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">map</span><span class="p">(</span><span class="err">*)</span><span class="w"></span></code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="o">)</span> <span class="k">as</span><span class="w"> </span><span class="kt">map</span><span class="p">(</span><span class="err">*)</span><span class="w"> </span><span class="err">{</span><span class="w"></span></code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="kt">map</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">    </span><span class="s1">'selection'</span><span class="p">:</span><span class="w"> </span><span class="nv">$</span><span class="n">context</span><span class="p">/</span><span class="nt">children</span><span class="p">[</span><span class="nt">symbol</span><span class="p">[</span><span class="na">@name</span><span class="o">=</span><span class="s1">'decimal'</span><span class="p">]]/</span><span class="na">@id</span><span class="w"></span></code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="p">}</span><span class="w"></span></code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code><span class="p">};</span><span class="w"></span></code></span></span>
</pre></div><p>For example:</p><div class="pre-wrap"><pre class="screen verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \</code></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="userinput">            --pretty-print --function-library:numbers.xqy</code></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">Found 2 possible parses.</code></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;</code></code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;bad&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;cafe&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;42&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;/number-list&gt;</code></code></span></span>
</pre></div><p>For a more complete discussion of how such functions can be written and what is available
in <code>$alternatives</code>, see 
<a href="https://coffeesacks.nineml.org/ch07.html" class="link">Chapter 7. Choosing among alternatives</a>
in the <a href="https://coffeesacks.nineml.org/" class="link">CoffeeSacks</a> documentation.</p></section><section id="choose-xpath" class="section"><header><h2><span class="label">6<span class="sep">.</span>2</span><span class="sep">. </span>Using XPath expressions</h2></header><p>An alternative to using a function library is to specify one or
more XPath expressions. For each place where ambiguity occurs, each
expression is evaluated with each alternative as the context item. The
first expression that has an effective boolean value of “true”, selects
the alternative to which it was applied.</p><p>For example:</p><div class="pre-wrap"><pre class="screen verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \</code></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="userinput">            --pretty-print --choose symbol[@name='decimal']</code></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">Found 2 possible parses.</code></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;number-list&gt;</code></code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;bad&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;cafe&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;decimal&gt;42&lt;/decimal&gt;</code></code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;/number-list&gt;</code></code></span></span>
</pre></div><p>Observe that because a unique choice was made, the result is not marked as ambiguous.
You can override that with the <code class="option"><a href="ch02.html#_strict-ambiguity">--strict-ambiguity</a></code>
option:</p><div class="pre-wrap"><pre class="screen verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \</code></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="userinput">            --pretty-print --strict-ambiguity --choose symbol[@name='decimal']</code></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">Found 2 possible parses.</code></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;</code></code></span></span>
<span class="line" db-line="5"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;bad&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;hex&gt;cafe&lt;/hex&gt;</code></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">   &lt;decimal&gt;42&lt;/decimal&gt;</code></code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><code class="computeroutput">&lt;/number-list&gt;</code></code></span></span>
</pre></div></section></section></main><nav class="bottom"><div class="navrow"><div class="navleft"><a title="Chapter  5 .  Ambiguity" href="ch05.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="Chapter  7 .  Configuration" href="ch07.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle">Chapter  5 .  Ambiguity</div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle">Chapter  7 .  Configuration</div></div><div class="infofooter"><span class="copyrightfooter">Copyright © 2022–2023 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that don’t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div db-persistent-toc="persistent-toc.html" db-prefix="">Loading…</div></script></nav></body></html>